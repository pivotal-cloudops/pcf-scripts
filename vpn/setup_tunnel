#!/bin/bash

set -e

chmod 400 config/id_rsa_jb config/pcf

. .venv/bin/activate

# enter local workstation password to update sudo timer
sudo -v

# clear dns cache, only on macs
uname | grep Darwin && sudo killall -HUP mDNSResponder

for i in 1 2 3; do
  sshuttle --verbose --verbose --dns --remote=clubawa@inner 10/8 \
    --exclude=10.81.0.0/16 \
    --exclude=10.84.0.0/16 \
    --exclude=10.4.0.0/16 \
    --ssh-cmd 'ssh -i config/pcf -F config/ssh_config'
  echo "lost connection? will retry in 5 seconds"
  sleep 5
done
